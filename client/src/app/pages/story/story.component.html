<main class="site-main outer">
  <div class="inner">
    <article class="post-full post">
      <header class="post-full-header">
        <div class="post-full-meta">
          <time class="post-full-meta-date" datetime="2017-11-07">7 November 2017</time>
          <span class="date-divider">/</span> <a href="/tag/new-things/">{{story?.story.conditionDetails.category}}</a>
        </div>
        <h1 class="post-full-title">{{story?.story.storyDetails.title}}</h1>
      </header>

      <figure class="post-full-image" [style.backgroundImage]="story && 'url(' + story?.story.storyDetails.mainImage + ')'">
        <div class="post-full-introauthors">
          <app-author-list [authors]="participants" [showDetailed]="true"></app-author-list>
        </div>
      </figure>

      <section class="post-full-content">
        <div *ngIf="canSeeConditionDetails()" class="form-row">
          <div class="form-group col">
            <button *ngIf="viewState !== ViewState.STORY"
                    (click)="viewState = ViewState.STORY" class="btn btn-outline-primary btn-block">
              Read Story
            </button>
            <button *ngIf="viewState === ViewState.STORY"
                    (click)="viewState = ViewState.CONDITION" class="btn btn-outline-primary btn-block">
              Read Condition Details
            </button>
          </div>

          <div *ngIf="canSubmitResearch()" class="form-group col">
            <button *ngIf="viewState === ViewState.RESEARCH"
                    (click)="viewState = ViewState.CONDITION" class="btn btn-outline-primary btn-block">
              Read Condition Details
            </button>
            <button *ngIf="viewState !== ViewState.RESEARCH"
                    (click)="viewState = ViewState.RESEARCH" class="btn btn-outline-success btn-block">
              Submit Research
            </button>
          </div>
        </div>

        <div *ngIf="viewState === ViewState.STORY" class="kg-card-markdown">
          <p>{{story?.story.storyDetails.details}}</p>
        </div>

        <div *ngIf="viewState === ViewState.CONDITION">
          <app-condition [details]="story?.story.conditionDetails"></app-condition>
        </div>

        <div *ngIf="viewState === ViewState.RESEARCH">
          <app-research [storyId]="story?.id"></app-research>
        </div>
      </section>
    </article>
  </div>
</main>

<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">
      <app-post-card class="read-next-card" [details]="fundingCardDetails">
        <form [formGroup]="fundingForm">
          <div class="d-inline-flex justify-content-between align-items-center">
            <div class="form-group">
              <div class="input-group">
                <input type="number" formControlName="diagAmount" class="form-control form-control-lg" placeholder="100.00">
                <div class="input-group-append">
                  <span class="input-group-text">DIAG</span>
                </div>
              </div>
            </div>
            <div class="form-group mx-2">
              <img class="spacer-icon" src="/assets/convert-icon.svg" alt="≈">
            </div>
            <div class="form-group">
              <div class="input-group">
                <input type="number" formControlName="currencyAmount" class="form-control form-control-lg" placeholder="10.00">
                <div class="input-group-append">
                  <span class="input-group-text">USD</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <input type="submit" value="Contribute" (click)="onSubmitContribution()" class="btn btn-primary btn-block">
          </div>
        </form>
      </app-post-card>

      <app-post-card *ngIf="!canAssignRoles()" class="read-next-card post-card-secondary" [details]="researchCardDetails">
        <input type="button" value="Submit Research Request" (click)="onRequestToResearch()" class="form-control btn btn-light">
      </app-post-card>

      <app-post-card *ngIf="canAssignRoles() && hasResearchRequests()" class="read-next-card post-card-secondary" [details]="selectRolesCardDetails">
        <div *ngFor="let user of getObjectKeys(researchRequests)" class="form-group w-100">
          <div class="input-group">
            <input type="text" [value]="user" class="form-control" disabled>
            <div class="input-group-append" ngbDropdown>
              <button id="assign-role" class="btn btn-secondary" type="button" ngbDropdownToggle>Assign Role</button>
              <div aria-labelledby="assign-role" ngbDropdownMenu>
                <button (click)="onAssignRole(user, TaskRole.WORKER)" class="dropdown-item">Assign as Researcher</button>
                <button (click)="onAssignRole(user, TaskRole.EVALUATOR)" class="dropdown-item">Assign as Evaluator</button>
              </div>
            </div>
          </div>
        </div>
      </app-post-card>

      <app-post-card *ngIf="canAssignRoles() && !hasResearchRequests()" class="read-next-card post-card-secondary" [details]="inputRolesCardDetails">
        <form [formGroup]="researcherForm">
          <div class="form-row">
            <div class="form-group col">
              <label for="worker">Researcher</label>
              <input type="text" formControlName="worker" id="worker" class="form-control" placeholder="e.g. 0x90F8bf…">
            </div>

            <div class="form-group col">
              <label for="evaluator">Evaluator</label>
              <input type="text" formControlName="evaluator" id="evaluator" class="form-control" placeholder="e.g. 0x6A479f…">
            </div>
          </div>

          <div class="form-group">
            <input type="submit" value="Assign Roles" (click)="onAssignRoles()" class="form-control btn btn-light btn-block">
          </div>
        </form>
      </app-post-card>
    </div>
  </div>
</aside>

<ng-template #researchRequestModal let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Request to Help Research</h4>
    <button type="button" class="close" aria-label="Close" (click)="d()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>Thank you for expressing interest in helping with the research for this story! You will be notified if the story
      coordinator chooses to have you help.</p>

    <form class="post-form">
      <div class="gh-form-group">
        <label for="duration">Approximate Duration (days)</label>
        <input type="number" [(ngModel)]="duration" id="duration" name="duration" class="gh-input" min="1" placeholder="30">
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="c(duration)">Submit</button>
  </div>
</ng-template>
